# Исправления и улучшения LibLocker

## Дата: 2026-01-15

## Резюме

Исправлены критические баги и добавлены новые функции для улучшения управления сессиями:

1. ✅ Исправлена уязвимость аутентификации при разблокировке экрана
2. ✅ Исправлено отображение статуса подключения клиента на сервере
3. ✅ Локализованы статусы на русский язык
4. ✅ Добавлено отображение оставшегося времени сессии
5. ✅ Добавлена возможность редактировать время сессии во время её выполнения
6. ✅ Реализовано уведомление клиента об изменении времени администратором

---

## Детальное описание изменений

### 1. Исправление аутентификации при разблокировке (КРИТИЧЕСКОЕ)

**Проблема:** Экран блокировки принимал любой пароль и показывал сообщение об успешной разблокировке, но фактически не разблокировал экран. Также был хардкод пароль "admin".

**Решение:**
- Удален хардкод пароль "admin"
- Добавлена настоящая проверка пароля через функцию `verify_password()` с использованием bcrypt
- Класс `LockScreen` теперь получает `ClientConfig` для доступа к сохраненному хешу пароля
- Если пароль не установлен, показывается предупреждение, но разблокировка выполняется (для совместимости)
- Если пароль установлен, проверяется его корректность перед разблокировкой

**Измененные файлы:**
- `src/client/gui.py`: Обновлены методы `LockScreen.__init__()`, `check_password()`, и `MainClientWindow.on_timer_finished()`

**Код:**
```python
def check_password():
    password = password_input.text()
    admin_password_hash = self.config.admin_password_hash
    
    # Если пароль не установлен, предупреждаем но разрешаем
    if not admin_password_hash:
        QMessageBox.warning(
            dialog, 
            "Предупреждение", 
            "Пароль администратора не установлен!\nОбратитесь к администратору для настройки безопасности."
        )
        dialog.accept()
        self.close()
        return
    
    # Проверяем пароль через verify_password
    if verify_password(password, admin_password_hash):
        QMessageBox.information(dialog, "Успех", "Разблокировка выполнена")
        dialog.accept()
        self.close()
    else:
        QMessageBox.warning(dialog, "Ошибка", "Неверный пароль")
```

---

### 2. Исправление отображения статуса подключения клиента

**Проблема:** Сервер показывал статус "client online" даже когда клиентское приложение не было подключено.

**Решение:**
- Обновлена функция `update_clients_table()` для проверки реального подключения через словарь `server.connected_clients`
- Добавлена проверка: клиент считается онлайн только если его ID присутствует в `connected_clients`
- Статус теперь отражает реальное состояние соединения, а не только данные из базы

**Измененные файлы:**
- `src/server/gui.py`: Обновлен метод `MainWindow.update_clients_table()`

**Код:**
```python
# Получаем список подключенных клиентов
connected_client_ids = {info['client_id'] for info in self.server.connected_clients.values()}

# Определяем реальный статус на основе подключения
is_connected = client.id in connected_client_ids

if is_connected:
    if client.status == ClientStatus.IN_SESSION.value:
        status_text = "В сессии"
    else:
        status_text = "Онлайн"
else:
    status_text = "Оффлайн"
```

---

### 3. Локализация статусов на русский язык

**Проблема:** Статус "in session" отображался на английском языке.

**Решение:**
- Добавлен маппинг статусов на русский язык:
  - `online` → "Онлайн"
  - `offline` → "Оффлайн"
  - `in_session` → "В сессии"
  - `blocked` → "Заблокирован"
- Цветовое кодирование статусов:
  - Онлайн: зеленый цвет
  - В сессии: голубой цвет
  - Оффлайн: серый цвет

**Измененные файлы:**
- `src/server/gui.py`: Обновлен метод `MainWindow.update_clients_table()`

---

### 4. Отображение оставшегося времени сессии

**Проблема:** В колонке "Время сессии" ничего не отображалось.

**Решение:**
- Добавлен расчет оставшегося времени для активных сессий
- Для безлимитных сессий показывается прошедшее время с символом ∞
- Для ограниченных сессий показывается оставшееся время в формате "ЧЧ:ММ осталось"
- Если время истекло, показывается "Завершается..."

**Измененные файлы:**
- `src/server/gui.py`: Обновлен метод `MainWindow.update_clients_table()`

**Код:**
```python
if active_session:
    from datetime import datetime, timedelta
    if active_session.is_unlimited:
        # Для безлимита показываем прошедшее время
        elapsed = datetime.now() - active_session.start_time
        elapsed_minutes = int(elapsed.total_seconds() / 60)
        hours = elapsed_minutes // 60
        minutes = elapsed_minutes % 60
        time_text = f"∞ {hours:02d}:{minutes:02d}"
    else:
        # Для ограниченных сессий показываем оставшееся время
        end_time = active_session.start_time + timedelta(minutes=active_session.duration_minutes)
        remaining = end_time - datetime.now()
        if remaining.total_seconds() > 0:
            remaining_minutes = int(remaining.total_seconds() / 60)
            hours = remaining_minutes // 60
            minutes = remaining_minutes % 60
            time_text = f"{hours:02d}:{minutes:02d} осталось"
        else:
            time_text = "Завершается..."
```

---

### 5. Редактирование времени активной сессии

**Проблема:** Отсутствовала возможность изменить время сессии после её начала.

**Решение:**
- Добавлена кнопка "⏱️ Изменить время" в интерфейс сервера
- Создан метод `edit_session_time()` в GUI сервера
- Добавлен метод `update_session_time()` в серверный код для обновления времени в БД
- Добавлена валидация:
  - Можно редактировать только активные сессии
  - Нельзя изменить безлимитную сессию
  - Новое время должно быть больше 0

**Измененные файлы:**
- `src/server/gui.py`: Добавлены кнопка и метод `edit_session_time()`
- `src/server/server.py`: Добавлен метод `LibLockerServer.update_session_time()`

---

### 6. Уведомление клиента об изменении времени

**Проблема:** Клиент не узнавал об изменении времени сессии администратором.

**Решение:**

#### 6.1. Новый тип сообщения в протоколе
- Добавлен `MessageType.SESSION_TIME_UPDATE` в протокол
- Создан класс `SessionTimeUpdateMessage` для передачи нового времени

**Измененные файлы:**
- `src/shared/protocol.py`

**Код:**
```python
@dataclass
class SessionTimeUpdateMessage:
    """Сообщение об изменении времени сессии администратором"""
    new_duration_minutes: int
    reason: str = "admin_update"

    def to_message(self) -> Message:
        return Message(
            type=MessageType.SESSION_TIME_UPDATE.value,
            data=asdict(self)
        )
```

#### 6.2. Обработка на клиенте
- Добавлен callback `on_session_time_update` в `LibLockerClient`
- Добавлен обработчик `_handle_session_time_update()` в клиенте
- Добавлен сигнал `session_time_updated` в `ClientThread`

**Измененные файлы:**
- `src/client/client.py`: Добавлены callback и handler
- `src/client/gui.py`: Добавлен сигнал в `ClientThread`

#### 6.3. Обновление виджета таймера
- Добавлен метод `update_session_time()` в класс `TimerWidget`
- Пересчитывается время окончания сессии
- Показывается всплывающее уведомление пользователю

**Измененные файлы:**
- `src/client/gui.py`: Добавлен метод `TimerWidget.update_session_time()`

**Код:**
```python
def update_session_time(self, new_duration_minutes: int):
    """Обновить время сессии (вызывается при изменении админом)"""
    logger.info(f"Updating session time to {new_duration_minutes} minutes")
    
    if self.is_unlimited:
        logger.warning("Cannot update time for unlimited session")
        return
    
    # Обновляем время окончания
    self.end_time = self.start_time + timedelta(minutes=new_duration_minutes)
    self.total_seconds = new_duration_minutes * 60
    
    # Пересчитываем remaining_seconds
    now = datetime.now()
    if now >= self.end_time:
        self.remaining_seconds = 0
    else:
        remaining = self.end_time - now
        self.remaining_seconds = int(remaining.total_seconds())
    
    # Обновляем отображение
    self.update_display()
    
    # Показываем уведомление
    msg = QMessageBox(None)
    msg.setIcon(QMessageBox.Icon.Information)
    msg.setWindowTitle("LibLocker - Изменение времени")
    msg.setText(f"⏱️ Администратор изменил время сессии\n\nНовая длительность: {new_duration_minutes} минут")
    msg.setInformativeText("Время окончания сессии было обновлено.")
    msg.setStandardButtons(QMessageBox.StandardButton.Ok)
    msg.setWindowFlags(Qt.WindowType.WindowStaysOnTopHint)
    msg.exec()
```

#### 6.4. Callback в главном окне клиента
- Добавлен метод `on_session_time_updated()` в `MainClientWindow`
- Обновляются данные сессии в памяти

**Измененные файлы:**
- `src/client/gui.py`: Добавлен метод `MainClientWindow.on_session_time_updated()`

---

## Тестирование

Созданы три новых теста для проверки функциональности:

### test_password_auth.py
Тестирует:
- Хеширование паролей работает корректно
- Верификация паролей работает правильно
- Один и тот же пароль создает разные хеши (использование соли)

### test_session_time_update.py
Тестирует:
- Создание сообщений `SessionTimeUpdateMessage`
- Конвертация в протокольные сообщения
- Сериализация в словари
- Наличие типа сообщения в enum

### test_status_localization.py
Тестирует:
- Корректность значений в enum `ClientStatus`
- Правильность маппинга статусов на русский язык
- Полноту локализации (все статусы переведены)

**Результаты:** Все тесты пройдены успешно ✅

---

## Безопасность

### Улучшения безопасности:
1. Убрана уязвимость с хардкод паролем "admin"
2. Добавлена настоящая проверка пароля с использованием bcrypt
3. Хеши паролей никогда не сохраняются в открытом виде
4. Используется соль для каждого хеша (защита от rainbow tables)

### Рекомендации:
1. Администраторам необходимо установить пароль через вкладку "Настройки" → "Безопасность"
2. Минимальная длина пароля: 8 символов
3. Рекомендуется использовать сложные пароли с буквами, цифрами и спецсимволами

---

## Инструкция по использованию новых функций

### Для администратора:

1. **Установка пароля администратора:**
   - Откройте вкладку "Настройки"
   - В разделе "Безопасность" введите новый пароль
   - Подтвердите пароль
   - Нажмите "Установить пароль"

2. **Изменение времени активной сессии:**
   - Выберите клиента в таблице
   - Нажмите кнопку "⏱️ Изменить время"
   - Установите новое время (часы и минуты)
   - Нажмите "✅ Создать"
   - Клиент получит уведомление об изменении

3. **Проверка статуса подключения:**
   - Колонка "Статус" теперь показывает реальное состояние:
     - "Онлайн" (зеленый) - клиент подключен
     - "В сессии" (голубой) - клиент в активной сессии
     - "Оффлайн" (серый) - клиент не подключен

4. **Просмотр оставшегося времени:**
   - Колонка "Время сессии" показывает:
     - "∞ ЧЧ:ММ" для безлимитных сессий (прошедшее время)
     - "ЧЧ:ММ осталось" для ограниченных сессий (оставшееся время)
     - "Завершается..." если время истекло

### Для пользователя:

1. **Разблокировка экрана:**
   - После окончания сессии появится экран блокировки
   - Трижды кликните в правом верхнем углу
   - Введите пароль администратора
   - Нажмите "OK"

2. **Уведомление об изменении времени:**
   - При изменении времени администратором появится всплывающее окно
   - Окно покажет новую длительность сессии
   - Виджет таймера автоматически обновится

---

## Известные ограничения

1. Нельзя изменить ограниченную сессию на безлимитную (и наоборот)
2. Нельзя изменить время для безлимитной сессии
3. Клиент должен быть подключен для изменения времени
4. Уведомление на клиенте показывается только если виджет таймера активен

---

## Файлы изменены

1. `src/client/gui.py` - основные изменения в UI клиента
2. `src/client/client.py` - обработка сообщений протокола
3. `src/server/gui.py` - UI сервера и управление сессиями
4. `src/server/server.py` - серверная логика обновления времени
5. `src/shared/protocol.py` - новый тип сообщения

## Файлы созданы

1. `test_password_auth.py` - тесты аутентификации
2. `test_session_time_update.py` - тесты обновления времени
3. `test_status_localization.py` - тесты локализации
4. `CHANGES_SUMMARY.md` - этот документ

---

## Заключение

Все заявленные проблемы успешно исправлены:
- ✅ Уязвимость аутентификации устранена
- ✅ Статус подключения отображается корректно
- ✅ Интерфейс локализован на русский язык
- ✅ Время сессии отображается в реальном времени
- ✅ Администратор может изменять время во время сессии
- ✅ Клиент получает уведомления об изменениях

Система теперь более безопасна, функциональна и удобна в использовании.
