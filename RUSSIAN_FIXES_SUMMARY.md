# Исправления LibLocker

Этот документ описывает исправления двух критических проблем в системе LibLocker.

## Проблема 1: Ввод правильного пароля администратора закрывает программу

### Описание проблемы
Когда администратор вводил правильный пароль на экране блокировки (который показывается после окончания сессии), приложение полностью закрывалось вместо того, чтобы просто убрать блокировку и вернуться к главному окну.

### Причина
В методе `LockScreen.check_password()` при вводе правильного пароля вызывался `self.force_close()`, который закрывал экран блокировки. Но поскольку главное окно было скрыто, а виджет таймера уже закрыт, не оставалось видимых окон, и приложение полностью завершалось.

### Решение
1. Добавлен сигнал `unlocked` в класс `LockScreen`
2. Метод `check_password()` теперь испускает сигнал `unlocked` вместо прямого вызова `force_close()`
3. Добавлен обработчик `on_lock_screen_unlocked()` в `MainClientWindow`, который:
   - Закрывает экран блокировки
   - Показывает главное окно
   - Очищает данные сессии
4. Сигнал корректно подключается и отключается для предотвращения утечек памяти

### Измененные файлы
- `src/client/gui.py`

## Проблема 2: В статистике всегда написано что сессия была бесплатной

### Описание проблемы
В статистике все сессии отображались как бесплатные ("Бесплатно"), даже если они были настроены как платные с определенной стоимостью за час.

### Причина
При создании сессии в базе данных поле `cost` инициализировалось значением 0.0. При остановке сессии вычислялась только фактическая длительность (`actual_duration`), но стоимость (`cost`) никогда не пересчитывалась на основе настроек `free_mode` и `cost_per_hour`.

Кроме того, параметры `free_mode` и `cost_per_hour` не сохранялись в базу данных, поэтому не было возможности точно рассчитать стоимость при завершении сессии.

### Решение
1. Обновлена схема базы данных `SessionModel` с добавлением полей:
   - `cost_per_hour` (Float, по умолчанию 0.0) - стоимость руб./час
   - `free_mode` (Boolean, по умолчанию True) - бесплатный режим

2. Изменен метод `start_session()` в `server.py` для сохранения этих параметров при создании сессии

3. Изменен метод `stop_session()` в `server.py` для расчета стоимости:
   - Вычисляется фактическая длительность в минутах
   - Если `free_mode` = False и `cost_per_hour` > 0:
     - Длительность переводится в часы
     - Вычисляется стоимость = длительность_в_часах × стоимость_за_час
   - Иначе стоимость устанавливается в 0.0
   - Добавлена валидация для предотвращения отрицательных значений

### Измененные файлы
- `src/shared/database.py`
- `src/server/server.py`

### Формула расчета стоимости
```python
if not free_mode and cost_per_hour > 0:
    duration_hours = actual_duration_minutes / 60.0
    cost = duration_hours * cost_per_hour
else:
    cost = 0.0
```

### Примеры расчета
- Бесплатная сессия (60 минут): стоимость = 0.00 руб.
- Платная сессия (60 минут, 100 руб/час): стоимость = 100.00 руб.
- Платная сессия (30 минут, 50 руб/час): стоимость = 25.00 руб.

## Тестирование
Оба исправления были проверены:
1. ✓ Проверка синтаксиса подтвердила отсутствие ошибок компиляции
2. ✓ Логика расчета стоимости протестирована с различными сценариями
3. ✓ Структура сигналов в GUI коде проверена
4. ✓ Проверка безопасности CodeQL не выявила уязвимостей
5. ✓ Обратная связь от code review учтена и исправлена

## Примечание о миграции базы данных
Существующие базы данных автоматически получат новые колонки `cost_per_hour` и `free_mode` при запуске приложения, так как SQLAlchemy's `create_all()` добавит недостающие колонки. Однако существующие сессии в базе данных будут иметь значения по умолчанию (0.0 для cost_per_hour, True для free_mode), поэтому их стоимость останется 0.0.

## Итоговая статистика изменений
- Изменено файлов: 4
- Добавлено строк: 132
- Удалено строк: 2
- Создана документация: FIXES_DOCUMENTATION.md (на английском)

Все изменения минимальны и точечны, направлены на решение конкретных проблем без внесения избыточных изменений в кодовую базу.
