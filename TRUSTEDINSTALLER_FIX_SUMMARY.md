# Исправление ложного срабатывания для TrustedInstaller

## Проблема

Красный экран блокировки появлялся при обычной работе Windows, реагируя на процесс `TrustedInstaller.exe`, хотя никто не запускал никаких установок программ.

### Причина

Модуль мониторинга установки (`src/client/installation_monitor.py`) проверял имена процессов на наличие подстроки `'install'` в строке 168:

```python
if name in self.INSTALLER_PROCESSES or 'setup' in name or 'install' in name:
```

Это вызывало ложное срабатывание для `trustedinstaller.exe` - легитимного системного процесса Windows, отвечающего за установку обновлений Windows.

## Решение

Добавлен список исключений для системных процессов Windows (`SYSTEM_PROCESS_EXCLUSIONS`), который проверяется перед триггером тревоги.

### Изменения в коде

#### 1. Добавлен список исключений (строки 38-43)

```python
# Системные процессы-исключения (не триггерят тревогу даже если содержат 'setup' или 'install')
SYSTEM_PROCESS_EXCLUSIONS = {
    'trustedinstaller.exe',  # Windows Modules Installer (Windows Update service)
    'tiworker.exe',  # Windows Update worker process
    'wuauclt.exe',  # Windows Update AutoUpdate Client
}
```

#### 2. Обновлена логика проверки процессов (строки 163-166)

```python
# Пропускаем системные процессы из списка исключений
# (name уже в нижнем регистре, см. строку 154)
if name in self.SYSTEM_PROCESS_EXCLUSIONS:
    continue
```

### Включенные системные процессы

1. **trustedinstaller.exe** - Windows Modules Installer
   - Системная служба Windows для установки обновлений
   - Запускается автоматически при проверке и установке обновлений Windows
   - Не должна вызывать тревогу

2. **tiworker.exe** - Windows Update Worker Process
   - Рабочий процесс Windows Update
   - Выполняет фоновую работу по обновлению системы

3. **wuauclt.exe** - Windows Update AutoUpdate Client
   - Клиент автоматического обновления Windows
   - Может запускаться периодически для проверки обновлений

## Тестирование

Создан комплексный набор тестов (`test_trustedinstaller_exclusion.py`) с 6 тестовыми случаями:

### Тесты (все прошли успешно ✅)

1. ✅ **test_trustedinstaller_in_exclusion_list** - Проверка наличия в списке исключений
2. ✅ **test_tiworker_in_exclusion_list** - Проверка наличия tiworker в списке
3. ✅ **test_trustedinstaller_not_detected** - TrustedInstaller не вызывает тревогу
4. ✅ **test_legitimate_installer_detected** - Настоящие установщики обнаруживаются
5. ✅ **test_mixed_processes** - Смешанные процессы обрабатываются корректно
6. ✅ **test_case_insensitive_exclusion** - Регистронезависимое исключение работает

### Результаты тестирования

```
======================================================================
Ran 6 tests in 0.043s

OK
======================================================================
✓ ВСЕ ТЕСТЫ ПРОЙДЕНЫ
======================================================================
```

## Проверка безопасности

### CodeQL сканирование
✅ **0 уязвимостей найдено**

### Code Review
✅ **Все замечания учтены**
- Добавлен комментарий, документирующий зависимость от преобразования в нижний регистр

## Влияние изменений

### Что исправлено
- ✅ TrustedInstaller и другие системные процессы Windows больше не вызывают красный экран
- ✅ Обновления Windows могут устанавливаться без ложных тревог
- ✅ Пользователи не будут видеть красный экран во время нормальной работы системы

### Что НЕ изменилось
- ✅ Настоящие установщики (setup.exe, install.exe, installer.exe) по-прежнему обнаруживаются
- ✅ Скачивание установочных файлов (.exe, .msi) по-прежнему отслеживается
- ✅ Функциональность мониторинга установки не нарушена

## Файлы изменены

1. **src/client/installation_monitor.py**
   - Добавлен `SYSTEM_PROCESS_EXCLUSIONS` (3 строки)
   - Обновлена логика `_check_installer_processes()` (4 строки)
   - Общее: минимальные изменения для максимального эффекта

2. **test_trustedinstaller_exclusion.py** (новый файл)
   - Комплексный набор тестов
   - 6 тестовых случаев
   - 153 строки кода

## Заключение

Проблема успешно решена минимальными изменениями кода. Добавление списка исключений для системных процессов Windows устраняет ложные срабатывания, сохраняя при этом полную функциональность мониторинга установки программ.

### Статус
✅ **ИСПРАВЛЕНИЕ ГОТОВО К ПРОДАКШЕНУ**

- ✅ Все тесты пройдены (6/6)
- ✅ CodeQL сканирование: 0 уязвимостей
- ✅ Code Review: все замечания учтены
- ✅ Минимальные изменения кода
- ✅ Обратная совместимость сохранена
- ✅ Документация добавлена

---

**Дата исправления**: 23 января 2026  
**Ветка**: copilot/fix-red-screen-issue  
**Коммиты**: 3 коммита
