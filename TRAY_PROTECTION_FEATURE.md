# System Tray Protection Feature

## Обзор

Данная функция добавляет защиту клиентского приложения LibLocker от случайного закрытия путем интеграции с системным треем Windows.

## Основные возможности

### 1. Сворачивание в трей вместо закрытия
- При нажатии на кнопку закрытия (X) клиентское приложение не закрывается, а сворачивается в системный трей
- При первом сворачивании отображается уведомление, информирующее пользователя о новом поведении

### 2. Контекстное меню трея
При нажатии правой кнопкой мыши (ПКМ) на иконку в трее отображается меню с двумя опциями:
- **Развернуть** - показывает главное окно клиента
- **Закрыть клиент** - закрывает клиентское приложение (с проверкой пароля)

### 3. Защита паролем
При выборе опции "Закрыть клиент" из меню трея:
- Отображается диалоговое окно с запросом пароля администратора
- Клиент закроется только после ввода правильного пароля
- Если пароль не установлен, отображается предупреждение с подтверждением

### 4. Двойной клик
Двойной клик по иконке в трее разворачивает главное окно клиента.

## Использование

### Для пользователя

1. **Сворачивание клиента**: Нажмите кнопку X или закройте окно - клиент свернется в трей
2. **Разворачивание клиента**: 
   - Двойной клик по иконке в трее, или
   - ПКМ на иконке → "Развернуть"
3. **Закрытие клиента**:
   - ПКМ на иконке → "Закрыть клиент"
   - Введите пароль администратора
   - Нажмите "OK"

### Для администратора

Пароль администратора настраивается в конфигурационном файле `config.client.ini`:
```ini
[security]
admin_password_hash = <хеш пароля>
```

Для генерации хеша пароля используйте утилиту `setup_config.py`.

## Технические детали

### Измененные файлы
- `src/client/gui.py` - добавлена функциональность системного трея

### Новые методы в MainClientWindow
- `init_tray_icon()` - инициализация иконки трея и меню
- `on_tray_icon_activated(reason)` - обработка кликов по иконке трея
- `show_window()` - показ главного окна
- `exit_with_password_check()` - проверка пароля перед выходом
- `force_exit()` - принудительное закрытие приложения

### Изменения в существующих методах
- `__init__()` - добавлен вызов `init_tray_icon()`
- `closeEvent()` - изменено поведение на сворачивание в трей

## Безопасность

- Пароль администратора хранится в виде bcrypt хеша
- Используется существующая функция `verify_password()` из модуля `shared.utils`
- При отсутствии пароля отображается предупреждение перед закрытием

## Тестирование

Добавлен файл `test_tray_icon.py` с полным набором unit-тестов, проверяющих:
- Наличие необходимых импортов
- Инициализацию иконки трея
- Наличие пунктов меню
- Проверку пароля при выходе
- Сворачивание в трей вместо закрытия
- Показ окна при двойном клике

Запуск тестов:
```bash
python test_tray_icon.py
```

## Совместимость

- Требуется PyQt6 >= 6.6.1
- Работает на Windows с поддержкой системного трея
- Кроссплатформенная поддержка (Linux/macOS) через QSystemTrayIcon

## Известные ограничения

- Иконка трея использует стандартную иконку Qt (можно заменить на пользовательскую)
- При первом сворачивании показывается информационное уведомление (только один раз)

## Будущие улучшения

Возможные улучшения:
- Добавление пользовательской иконки приложения
- Дополнительные пункты меню (например, "О программе", "Настройки")
- Анимация иконки при активной сессии
- Отображение оставшегося времени в подсказке трея
