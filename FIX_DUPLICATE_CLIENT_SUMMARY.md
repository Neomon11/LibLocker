# Исправление дублирования клиентов и добавление функции изменения порядка

## Обзор

Данный PR исправляет две проблемы:

1. **Исправление дублирования клиентов**: Иногда один и тот же клиент отображался дважды в списке, хотя ни имя, ни IP-адрес не менялись
2. **Возможность изменения порядка клиентов**: Добавлена возможность менять порядок отображения клиентов в списке

## Проблема 1: Дублирование клиентов

### Причина
Когда клиент переподключался к серверу (например, после потери соединения или перезапуска), создавалось новое socket-подключение с новым socket ID. При этом старое подключение не удалялось из словаря `connected_clients`, что приводило к тому, что один и тот же клиент (с одним HWID) имел несколько socket ID и мог отображаться несколько раз.

### Решение
Модифицирован метод `_handle_client_register` в `src/server/server.py`:
- Перед добавлением нового подключения проверяется, существует ли уже подключение с таким же HWID
- Если существует, старое подключение удаляется из `connected_clients`
- Новое подключение добавляется с новым socket ID

### Код изменения
```python
# Проверяем, есть ли уже подключение с этим HWID
# Если да - удаляем старое (предотвращение дубликатов)
old_sid = None
for existing_sid, info in list(self.connected_clients.items()):
    if info.get('hwid') == hwid and existing_sid != sid:
        old_sid = existing_sid
        logger.info(f"Removing old connection for HWID {hwid}: {existing_sid}")
        del self.connected_clients[existing_sid]
        break
```

## Проблема 2: Изменение порядка клиентов

### Решение
Добавлена функциональность изменения порядка отображения клиентов:

1. **Новая колонка в БД**: Добавлена колонка `display_order` в таблицу `clients`
2. **Автоматическая миграция**: При запуске сервера автоматически добавляется колонка `display_order` для существующих баз данных
3. **UI элементы**: Добавлены пункты "⬆️ Переместить вверх" и "⬇️ Переместить вниз" в контекстное меню клиентов
4. **Сортировка**: Таблица клиентов теперь сортируется по `display_order`

### Изменения в файлах

#### src/shared/database.py
- Добавлена колонка `display_order` в `ClientModel`
- Добавлена миграция для существующих БД с последовательным присвоением значений (1, 2, 3...)

#### src/server/server.py
- При создании нового клиента ему присваивается `display_order = max(display_order) + 1`
- Используется `func.max()` для корректного определения максимального значения

#### src/server/gui.py
- Метод `update_clients_table` сортирует клиентов по `display_order`
- Добавлены методы `move_client_up()` и `move_client_down()` для изменения порядка
- В контекстное меню добавлены соответствующие пункты

### Использование
1. Щелкните правой кнопкой мыши на клиенте в таблице
2. Выберите "⬆️ Переместить вверх" или "⬇️ Переместить вниз"
3. Клиент меняется местами с соседним клиентом
4. Порядок сохраняется в БД и восстанавливается после перезапуска

## Тестирование

Созданы два теста:

1. **test_client_duplication_fix.py** - проверяет, что:
   - Клиент не дублируется при повторном подключении
   - Старое подключение удаляется при новом подключении с тем же HWID
   - Разные клиенты корректно поддерживаются одновременно

2. **test_client_reordering.py** - проверяет, что:
   - Клиенты создаются с правильным `display_order`
   - Порядок клиентов можно изменять
   - Сортировка по `display_order` работает корректно

Все тесты проходят успешно:
```
✅ Все тесты пройдены успешно!
   - Дублирование клиентов исправлено
   - Повторное подключение корректно обрабатывается
   - Старые socket ID удаляются при новом подключении

✅ Все тесты изменения порядка пройдены успешно!
   - Клиенты корректно создаются с display_order
   - Порядок клиентов можно изменять
   - Сортировка по display_order работает правильно
```

## Безопасность

Проведен анализ безопасности с помощью CodeQL - уязвимостей не обнаружено.

## Совместимость

- Автоматическая миграция БД при первом запуске
- Существующие клиенты получают последовательные значения `display_order` (1, 2, 3...)
- Обратная совместимость полностью сохранена
